
import crypto from "crypto";

let smartContractExtractedReportData = "0x19636e6b9fb118f5379ee2090309c550a172f8e4ecadef646bb958f9e7442b830c6324560ac28100e588507475a73ccefb05c1b3d3b0f5970f08c70fcc33e008"

/*
let teeResponse = {
    "verification": {
        "Ok": {
            "is_valid": true,
            "server_name": "openbanking-api-826260723607.europe-west3.run.app",
            "score": "59",
            "verifying_key": "037b48f19c139b6888fb5e383a4d72c2335186fd5858e7ae743ab4bf8e071b06e7",
            "sent_hex_encoded": "4745542068747470733a2f2f6f70656e62616e6b696e672d6170692d3832363236303732333630372e6575726f70652d77657374332e72756e2e6170702f75736572732f6161612f6372656469742d73636f726520485454502f312e310d0a686f73743a206f70656e62616e6b696e672d6170692d3832363236303732333630372e6575726f70652d77657374332e72756e2e6170700d0a636f6e6e656374696f6e3a20636c6f73650d0a636f6e74656e742d6c656e6774683a20300d0a0d0a",
            "sent_readable": "GET https://openbanking-api-826260723607.europe-west3.run.app/users/aaa/credit-score HTTP/1.1\r\nhost: openbanking-api-826260723607.europe-west3.run.app\r\nconnection: close\r\ncontent-length: 0\r\n\r\n",
            "recv_hex_encoded": "485454502f312e3120323030204f4b0d0a5858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858587365727665723a20476f6f676c652046726f6e74656e640d0a416c742d5376633a2068333d223a343433223b206d613d323539323030302c68332d32393d223a343433223b206d613d323539323030300d0a436f6e6e656374696f6e3a20636c6f73650d0a5472616e736665722d456e636f64696e673a206368756e6b65640d0a585858585858582270617468223a222f75736572732f6161612f6372656469742d73636f72652258226d657373616765223a224372656469742073636f726520726574726965766564207375636365737366756c6c792258585858585858585822757365724964223a2261616122585858585858585858582276616c7565223a353958585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858",
            "recv_readable": "HTTP/1.1 200 OK\r\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXserver: Google Frontend\r\nAlt-Svc: h3=\":443\"; ma=2592000,h3-29=\":443\"; ma=2592000\r\nConnection: close\r\nTransfer-Encoding: chunked\r\nXXXXXXX\"path\":\"/users/aaa/credit-score\"X\"message\":\"Credit score retrieved successfully\"XXXXXXXXX\"userId\":\"aaa\"XXXXXXXXXX\"value\":59XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            "time": "2025-06-20T19:56:17+00:00"
        }
    },
    "attestation": {
        "Ok": {
            "quote": "040002008100000000000000939a7233f79c4ca9940a0db3957f06075fdd5ea20205694b1240ffe054cfd68300000000060104000000000000000000000000005b38e33a6487958b72c3c12a938eaa5e3fd4510c51aeeab58c7d5ecee41d7c436489d6c8e4f92f160b7cad34207b00c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000702000000000000c68518a0ebb42136c12b2275164f8c72f25fa9a34392228687ed6e9caeb9c0f1dbd895e9cf475121c029dc47e70e91fd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000836c3ae3b79ed66df7cc74e1911fe5331ce7549426c6e2f38e2fd75388b959a33fc8c947379d39a94b359e915a89d70154e08f5c1f7b1fce4cbfe1c14f3ba67b70044ede2751487279cd1f2e4239dee99a6d45e24ebde6b6a6f5ae49878e0e69edcd363660e85b71c318324996dda756c372d9f6960edbfa863b1e684822eb48dd95e218ae2b78e51ef97f3b8f5c9dc50d80536fc368f3fe030677e8043750ed30d8fecd45518c27e6405bcd5dc2e549ac5b08d1a25edf8d56b7b1093ffdb3219636e6b9fb118f5379ee2090309c550a172f8e4ecadef646bb958f9e7442b830c6324560ac28100e588507475a73ccefb05c1b3d3b0f5970f08c70fcc33e008d0100000bb3abee0a0435280245373d8495f2d29df1239d13e7def45505d79770c0f5c0dcffc25819b11a363929dbf682e24a4dd51a3b439ee64d0e01bed532a2e295b58279c9edd68fab43c656735ef76079743e58b58bd522e5d9653186212a3659c973f9af53b58e80c267795bee407bed6b503e10a53399eba560159e8b5716df91d06004a1000000404090905ff00020000000000000000000000000000000000000000000000000000000000000000000000000000000015000000000000000700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e3e85f8a38b1ab3f2d2d7b6f27d990848ba3edbabfba547d9a0cf66fed1e17a000000000000000000000000000000000000000000000000000000000000000055d178ac6fa649b5b8d626a98950ef575d5e12b579f7341ded1d3e49aca27f207722e597c4fdf3ea73c0fa72f38942906733dacf4c6229a1d557e96d5d53c5c62000000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f0500620e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d494945386a4343424a6567417749424167495550564e565753427351747a4344656468716a7953754f303562474177436759494b6f5a497a6a3045417749770a634445694d434147413155454177775a535735305a577767553064594946424453794251624746305a6d397962534244515445614d42674741315545436777520a535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d51737743515944565151490a44414a445154454c4d416b474131554542684d4356564d774868634e4d6a55774e7a4d784d4463794f4451795768634e4d7a49774e7a4d784d4463794f4451790a576a42774d534977494159445651514444426c4a626e526c624342545231676755454e4c49454e6c636e52705a6d6c6a5958526c4d526f77474159445651514b0a4442464a626e526c6243424462334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e560a4241674d416b4e424d517377435159445651514745774a56557a425a4d424d4742797147534d34394167454743437147534d34394177454841304941424e715a0a71516251626436394e58534e554846356c3055616c3865465175706d2f774553684d673864416b6c536f5376576348324d557841336155414b6a6a715058326d0a524179766c6f57533364356b56706a587275696a67674d4e4d4949444354416642674e5648534d4547444157674253566231334e765276683655424a796454300a4d383442567776655644427242674e56485238455a4442694d47436758714263686c706f64485277637a6f764c32467761533530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c334e6e6543396a5a584a3061575a7059324630615739754c3359304c33426a61324e796244396a595431770a624746305a6d397962535a6c626d4e765a476c755a7a316b5a584977485159445652304f4242594546496c7631526b35584c345a336c434c4f673368334931470a42616d624d41344741315564447745422f775145417749477744414d42674e5648524d4241663845416a41414d4949434f67594a4b6f5a496876684e415130420a424949434b7a4343416963774867594b4b6f5a496876684e41513042415151514e55347148486e4a6a6f46795071744c654c6d51707a434341575147436971470a534962345451454e41514977676746554d42414743797147534962345451454e41514942416745454d42414743797147534962345451454e41514943416745450a4d42414743797147534962345451454e41514944416745434d42414743797147534962345451454e41514945416745434d42414743797147534962345451454e0a41514946416745464d42454743797147534962345451454e41514947416749412f7a415142677371686b69472b453042445145434277494241444151426773710a686b69472b4530424451454343414942416a415142677371686b69472b45304244514543435149424144415142677371686b69472b45304244514543436749420a4144415142677371686b69472b45304244514543437749424144415142677371686b69472b45304244514543444149424144415142677371686b69472b4530420a44514543445149424144415142677371686b69472b45304244514543446749424144415142677371686b69472b453042445145434477494241444151426773710a686b69472b45304244514543454149424144415142677371686b69472b45304244514543455149424454416642677371686b69472b45304244514543456751510a424151434167582f4141494141414141414141414144415142676f71686b69472b45304244514544424149414144415542676f71686b69472b453042445145450a424159676f473841414141774477594b4b6f5a496876684e4151304242516f424154416542676f71686b69472b453042445145474242416d462f5463654962390a51635534474f6e6c545766304d45514743697147534962345451454e415163774e6a415142677371686b69472b45304244514548415145422f7a4151426773710a686b69472b45304244514548416745422f7a415142677371686b69472b45304244514548417745422f7a414b42676771686b6a4f5051514441674e4a414442470a41694541324e6b6e7052306f456b30575a486c42705273796d686370594f2b6c307073702b434451474a7047796a73434951446f38544466494f675a445567580a623672633368687542523265793871666a3076724534696e707441554a773d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484178496a41670a42674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d45556c75644756730a49454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b474131554543417743513045780a437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f377432316c58534f0a3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553786c6d546c4a6c0a65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f536347724442530a42674e5648523845537a424a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e5648513445466751556c5739640a7a62306234656c4153636e553944504f4156634c336c517744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159420a4166384341514177436759494b6f5a497a6a30454177494452774177524149675873566b6930772b6936565947573355462f32327561586530594a446a3155650a6e412b546a44316169356343494359623153416d4435786b66545670766f34556f79695359787244574c6d5552344349394e4b7966504e2b0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "signature_hex_encoded": "3b756c4adfce4063cd58b65bbe6e6fe605b9f36f8b1b526d205d6c8b0913ab5f1a88abe837fdf0113340a165b105d860281dd1edcd658b2243739ac5f027f028",
            "verifying_key_hex_encoded": "04d0c782aecac89df1e29481de5f9616811ad2280c6f997a9ed089045560b2150f0b7549cb12ff3717e3be745d1fc290191864b39220dc563c8cd0c995ea70f6c0",
            "verifying_key_certificate_chain": [
                "-----BEGIN CERTIFICATE-----\nMIIBRDCB6qADAgECAhRsaQOJEMb2qWgKdGFyQE0AmGzwYTAKBggqhkjOPQQDAjA5\nMTcwNQYDVQQDDC41YmM3MTFkMjYxMDU2NWNiYzk2MDk1MjdhYmExYTc4NDZjNmYy\nMjM3LnBoYWxhMB4XDTc1MDEwMTAwMDAwMFoXDTI2MDgwNjE2NDQwOFowCzEJMAcG\nA1UEAwwAMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE0MeCrsrInfHilIHeX5YW\ngRrSKAxvmXqe0IkEVWCyFQ8LdUnLEv83F+O+dF0fwpAZGGSzkiDcVjyM0MmV6nD2\nwDAKBggqhkjOPQQDAgNJADBGAiEAnYL0TLQBE7ubziKj+C64+RFAwIgfbhhkIuZ8\nP6z9oGQCIQDlGQFkKt8IvrS4+dCoXMkjM3p8TymAgX1OyfsTH8pIUg==\n-----END CERTIFICATE-----\n",
                "-----BEGIN CERTIFICATE-----\nMIIBqTCCAU+gAwIBAgIUVkiV8KC1QgYZ2DzqGkGwTMX0d/gwCgYIKoZIzj0EAwIw\nOTE3MDUGA1UEAwwuNWJjNzExZDI2MTA1NjVjYmM5NjA5NTI3YWJhMWE3ODQ2YzZm\nMjIzNy5waGFsYTAeFw03NTAxMDEwMDAwMDBaFw0yNjA4MDYxNjQzNDhaMDkxNzA1\nBgNVBAMMLjViYzcxMWQyNjEwNTY1Y2JjOTYwOTUyN2FiYTFhNzg0NmM2ZjIyMzcu\ncGhhbGEwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAAT9HIonjZ12d+Hn1Bifgm2b\nzjv/LxfbCvE9jpbMOFp+si8yQy0Zd5gTiXQcvlAK7Vx92vBkGefg+OaQ6+F9PQcz\nozUwMzAdBgNVHQ4EFgQUKu2SfbCvsKHcPVfU4Q6sVbkbRakwEgYDVR0TAQH/BAgw\nBgEB/wIBATAKBggqhkjOPQQDAgNIADBFAiBPxB3pfGD5vtzjg0S1HNTbalcQWV3U\njnk0cLlPPpi29QIhAJhHljqK7X1f5EEP+LwHBn+7AsHSGE/hV292GGvZ1aJI\n-----END CERTIFICATE-----\n"
            ]
        }
    }
}
*/

// Pass the response body from TEE directly into this function to verify the attestations
async function verifyTeeResponse(
    responseBody: string,
): Promise<Boolean> {
    // parse the response body to check if it contains attestation field
    const response = JSON.parse(responseBody);
    const isValid = await checkTeeResponseFields(responseBody);
    if (!isValid) {
        return false;
    }
    const attestation = await checkAttestationFields(response.attestation);
    if (!attestation) {
        return false;
    }


    // extract the reportData from the attestation
    const [isQuoteValid, reportData] = await verifyQuoteOnChain(attestation.quote);
    if (!isQuoteValid) {
        console.error("Quote verification on chain failed");
        return false;
    }

    // check if the reportData matches the expected value 
    const isReportDataValid = await assertReportData(reportData, response.verification);

    if (!isReportDataValid) {
        console.error("Report data validation failed");
        return false;
    }

    const isSignatureValid = await verifyQuoteSignature(
        attestation.quote,
        attestation.signature_hex_encoded,
        attestation.verifying_key_hex_encoded
    );

    if (!isSignatureValid) {
        console.error("Signature verification failed");
        return false;
    }




    return true;
}

async function verifyQuoteSignature(
    quote: string,
    signatureHexEncoded: string,
    verifyingKeyHexEncoded: string
): Promise<boolean> {


    // Step 1: encode the quote to retrieve msg
    // let msg = {...}

    // Step 2: Given signature encoded as hex, decode it and get signature
    // let signature = {...}


    // Step 3: Given verifying key encoded as hex, decode it and contstruct verifying key
    // let verifyingKey = {...}

    // Step 4: Verify the signature using the verifying key and the message
    // let isValid = {...}
    // eg.
    /*
    const isValid = await crypto.subtle.verify(
        { name: "ECDSA", hash: { name: "SHA-256" } },
            verifyingKey,
            signature,
            messageBytes
        );
    */

    return true;
}

async function assertReportData(
    expectedReportData: string,
    verificationBody: any // ← raw JSON string of verification body
): Promise<boolean> {

    let actualReportData = await prepareReportDataFromVerificationBody(verificationBody);

    const match = actualReportData === expectedReportData;
    if (!match) {
        console.error("Report data does not match");
        console.error("Expected:", expectedReportData);
        console.error("Actual  :", actualReportData);
    }

    return match;
}


async function prepareReportDataFromVerificationBody(
    verificationBody: any, // raw JSON string of verification body
): Promise<string> {
    // Step 1: Hex-encode the verification result 
    /*
    "Ok": {
            "is_valid": true,
            "server_name": "openbanking-api-826260723607.europe-west3.run.app",
            "score": "59",
            "verifying_key": "037b48f19c139b6888fb5e383a4d72c2335186fd5858e7ae743ab4bf8e071b06e7",
            "sent_hex_encoded": "4745542068747470733a2f2f6f70656e62616e6b696e672d6170692d3832363236303732333630372e6575726f70652d77657374332e72756e2e6170702f75736572732f6161612f6372656469742d73636f726520485454502f312e310d0a686f73743a206f70656e62616e6b696e672d6170692d3832363236303732333630372e6575726f70652d77657374332e72756e2e6170700d0a636f6e6e656374696f6e3a20636c6f73650d0a636f6e74656e742d6c656e6774683a20300d0a0d0a",
            "sent_readable": "GET https://openbanking-api-826260723607.europe-west3.run.app/users/aaa/credit-score HTTP/1.1\r\nhost: openbanking-api-826260723607.europe-west3.run.app\r\nconnection: close\r\ncontent-length: 0\r\n\r\n",
            "recv_hex_encoded": "485454502f312e3120323030204f4b0d0a5858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858587365727665723a20476f6f676c652046726f6e74656e640d0a416c742d5376633a2068333d223a343433223b206d613d323539323030302c68332d32393d223a343433223b206d613d323539323030300d0a436f6e6e656374696f6e3a20636c6f73650d0a5472616e736665722d456e636f64696e673a206368756e6b65640d0a585858585858582270617468223a222f75736572732f6161612f6372656469742d73636f72652258226d657373616765223a224372656469742073636f726520726574726965766564207375636365737366756c6c792258585858585858585822757365724964223a2261616122585858585858585858582276616c7565223a353958585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858585858",
            "recv_readable": "HTTP/1.1 200 OK\r\nXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXserver: Google Frontend\r\nAlt-Svc: h3=\":443\"; ma=2592000,h3-29=\":443\"; ma=2592000\r\nConnection: close\r\nTransfer-Encoding: chunked\r\nXXXXXXX\"path\":\"/users/aaa/credit-score\"X\"message\":\"Credit score retrieved successfully\"XXXXXXXXX\"userId\":\"aaa\"XXXXXXXXXX\"value\":59XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
            "time": "2025-06-20T19:56:17+00:00"
        }
    */
    // Step 2: Hash the hex string using SHA-512
    // Step 3: Hex-encode the hash again
    // Step 4: Prepend `0x`
    // const actualReportData = `0x${hashHex}`;

    // return expectedReportData for now
    return smartContractExtractedReportData;
}

async function checkTeeResponseFields(
    responseBody: any,
): Promise<Boolean> {
    if (!responseBody.verification) {
        console.error("Missing verification field in response");
        return false;
    }
    if (!responseBody.attestation) {
        console.error("Missing attestation field in response");
        return false;
    }

    return true;
}

async function checkAttestationFields(
    attestation: any,
): Promise<any | null> {
    if (!attestation || !attestation.Ok) {
        console.error("Invalid attestation format");
        return null;
    }

    const quote = attestation.Ok.quote;
    if (!quote) {
        console.error("Missing quote in attestation");
        return null;
    }

    // Check for other required fields in the quote
    if (!quote.signature_hex_encoded || !quote.verifying_key_hex_encoded) {
        console.error("Missing signature or verifying key in quote");
        return null;
    }
    if (!quote.verifying_key_certificate_chain || quote.verifying_key_certificate_chain.length === 0) {
        console.error("Missing verifying key certificate chain in quote");
        return null;
    }
    return attestation.Ok;
}

async function verifyQuoteOnChain(
    quote: string,
): Promise<[Boolean, string]> {
    // call to smart contract to verify the quote
    // This is a placeholder for the actual implementation
    console.log("Verifying quote on chain:", quote);
    // Do not forget to add prefix "0x" to the quote before passing to contract
    // eg. 04000200810 -> 0x04000200810
    return [true, smartContractExtractedReportData];
    //call 
}
